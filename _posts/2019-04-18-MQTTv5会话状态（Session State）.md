---
layout: splash
title:  "MQTT v5会话状态（Session State）"
date:   2019-04-19 18:14:44 +0800
categories: MQTT
header:
  overlay_image: /assets/images/IMGP8176.jpg
excerpt: >
     
tags: 
  - MQTT
---
# 会话状态

为了实现QoS 1和QoS 2协议流，客户端和服务器需要将状态与`ClientId`相关联，这称为会话状态。服务器还将`Subscription`存储为会话状态的一部分。

会话可以跨越一系列的多次网络连接而一直存在，直到最后一次连接断开加上会话到期间隔（`Session Expiry Interval`）。

客户端的会话状态包含：

* 已发送到服务器，但尚未完全确认的QoS 1和QoS 2消息。
* 已从服务器接收但尚未完全确认的QoS 2消息。

服务端的会话状态包含：

* 会话是否存在，即使会话的其余部分为空。
* 客户端的订阅信息，包含订阅ID。
* 已发送到客户端，但尚未完全确认的QoS 1和QoS 2消息。
* 等待传输到客户端的QoS 1和QoS 2消息以及等待传输到客户端的QoS 0消息(可选，取决于服务端配置项`mqueue_store_qos0`)。
* 客户端已经接收但尚未完全确认的QoS 2消息。遗嘱信息(`Will Message`)以及遗嘱延迟时间(`Will Delay Interval`)。
* 如果会话当前未连接，服务端保存该会话何时会被结束以及会话状态被丢弃。

保留消息（`Retained Message`）不构成服务端会话状态的一部分，当会话结束时，他们不会被删除。

## 保存会话状态

当网络连接未断开时，服务端和客户端不得丢弃会话状态；当网络连接已经断开并且已经过了会话过期间隔（`Session Expiry Interval`），服务端必须丢弃会话状态。

*非规范性注解*

    客户端和服务器的存储能力当然会在容量方面受到限制，并且可能受到管理策略的约束。存储会话状态可以由于管理员操作而被丢弃，包括对预定义条件的自动响应。这具有终止会话的效果。这些操作可能是由于资源限制而有意为之，或其他操作原因引起。硬件或软件故障可能导致客户端或服务器存储的会话状态丢失或损坏。谨慎地评估客户端和服务器的存储能力以确保它们够用。


## 会话状态非规范性示例

例如，电表读数解决方案可能使用QoS 1消息来保护读数免受网络上的丢失。解决方案开发人员可能已确定电源足够可靠，在这种情况下，客户端和服务器中的数据可以存储在易失性存储器中，而不会有太大的丢失风险。

相反，停车计费器支付应用程序提供商可能会决定永远不会由于网络或客户端故障而丢失支付消息。因此，它们要求在通过网络传输之前将所有数据写入非易失性存储器。



