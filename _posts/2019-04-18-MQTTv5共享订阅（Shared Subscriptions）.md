---
layout: splash
title:  "MQTT保留消息"
date:   2019-02-12 11:17:44 +0800
categories: MQTT
header:
  overlay_image: /assets/images/IMGP8176.jpg
excerpt: >
     
tags: 
  - MQTT
---
# 订阅
MQTT提供了两种订阅方式：共享的（Shared）和非共享的（Non‑shared）。

## 非共享订阅（Non‑shared Subscriptions）

非共享订阅仅与创建该订阅的MQTT会话相关，每个订阅包含一个Topic过滤器，指定了哪些Topic的消息可以被投递到该会话，以及一些订阅选项（Subscription Options）。服务端负责收集匹配该Topic过滤器的消息，并在当该会话连接活跃时将消息投递过去。

一个会话对于同一个Topic过滤器最多只能有一个非公向订阅，因此在同一个会话内，Topic过滤器可以用来作为区别订阅的关键。

如果有多个客户端使用非共享方式订阅了同一个Topic，那么每当有消息发布到该Topic，每个客户端都会收到一条该应用消息的副本。这意味着，由于在这种情况下每个消息都分发到每个订阅的客户端，非共享订阅不能用于订阅客户端之间的消息负载均衡。

## 共享订阅（Shared Subscriptions）

共享订阅可以与多个MQTT会话的订阅相关。与非共享订阅一样，它具有Topic过滤器和订阅选项（Subscription Options）;但是，与其Topic过滤器匹配的消息仅发送到其订阅的会话中的一个。在多个客户端并行共享消息处理的情况下，共享订阅非常有用。

我们使用特殊格式的Topic过滤器来识别共享订阅，其格式如下：

```
$share/{ShareName}/{filter}
```

* `$ share`是一个字符串，用于将Topic过滤器标记为共享订阅Topic过滤器；
* `{ShareName}`是一个不包含“/”，“+”或“＃”的字符串；
* `{filter}` 字符串的其余部分与非共享订阅中的Topic过滤器具有相同的语法和语义。

一个共享订阅的Topic过滤器必须以`$share`开头，而且必须包含一个`ShareName`，`ShareName`长度至少包含一个字符；`ShareName`不得包含字符“/”，“+”或“＃”，但必须后跟“/”字符，该“/”后边必须跟一个Topic过滤器。


共享订阅在MQTT服务器的范围内定义，而不是在会话中定义。`ShareName`包含在共享订阅的Topic过滤器中，以便在具有相同`{filter}`组件的服务器上可以有多个共享订阅。通常，应用程序使用`ShareName`来表示共享订阅的订阅Sessions组。

例如：

* 共享订阅`$share/consumer1/sport/tennis/+`和`$share/consumer2/sport/tennis/+`是不同的共享订阅，因此可以与不同的Sessions组相关联。它们都与`sport/tennis/+`的非共享订阅相匹配。

    如果发布了一条消息到匹配`sport/tennis/+`的Topic，那么订阅`$share/consumer1/sport/tennis/+`的多个会话中只有一个会收到这条消息，订阅了`$share/consumer2/sport/tennis/+`的多个会话中也只有一个会收到，但是每个以非共享方式订阅到`sport/tennis/+`的会话都会收到这条消息。

* 共享订阅`$share/consumer1//finance`与非共享订阅`/finance`匹配相同的Topic。

    请注意，`$share/consumer1//finance`与`$share/consumer1/sport/tennis/+`是两个完全不同的共享订阅，尽管它们的`ShareName`相同，虽然它们可能以某种方式相关，但它们之间不会仅仅因为具有相同的`ShareName`而具有特定的关系。



通过在SUBSCRIBE请求中使用共享订阅Topic过滤器来创建共享订阅。只要只有一个Session订阅特定的共享订阅，共享订阅的行为就像非共享订阅，但以下情况除外：

* 当与PUBLISH匹配时，Topic过滤器的`$share`和`{ShareName}`部分并未考虑在内
* 首次订阅时，不会将retained的消息发送到该会话，该会话会在其他匹配的消息发布时收到它们。

一旦一个共享订阅存在，其他会话可以使用相同的共享订阅Topic过滤器进行订阅。新会话作为附加订阅者与共享订阅相关联。retained的消息不会发送给此新订阅者。现在，与共享订阅匹配的每个后续应用程序消息都将发送到订阅共享订阅的一个且仅一个会话。

会话可以通过发送包含完整共享订阅Topic过滤器的UNSUBSCRIBE数据包来明确地从共享订阅中分离出来。会话终止时也会与共享订阅分离。

只要共享订阅与至少一个会话（即已向其主题过滤器发出成功的SUBSCRIBE请求并且尚未完成相应的UNSUBSCRIBE的会话）相关联，则共享订阅将持续。共享订阅在最初创建它的会话取消订阅时仍然存在，除非在发生这种情况时没有其他会话。共享订阅结束，并且当不再有任何会话订阅时，将删除与其关联的任何未传递的消息。


### 共享订阅说明
* 如果有多个会话订阅了共享订阅，则服务器的实现可以自由选择：可以逐个消息地选择要使用的会话以及用于进行此选择的条件。

* 允许不同的订阅客户端在其SUBSCRIBE包中请求不同的请求的QoS级别。服务器决定向每个客户端授予哪个最大QoS，并允许向不同的订阅者授予不同的最大QoS级别。在向客户端发送应用程序消息时，服务器必须尊重客户端订阅的授权QoS，与向Subscriber发送消息时一样。

* 如果服务器正在向其选择的订阅客户端发送QoS 2消息，并且在交付完成之前与客户端的连接中断，则服务器必须在重新连接时完成向该客户端的消息传递。如果客户端的会话（Session）在客户端重新连接之前终止，则服务器不得将应用程序消息发送给任何其他订阅的客户端。

* 如果服务器正在向其选择的订阅客户端发送QoS 1消息并且在服务器收到来自客户端的确认之前与该客户端的连接中断，则服务器可以等待客户端重新连接并重新发送消息到那个客户。如果客户端的会话（Session）在客户端重新连接之前终止，则服务器应该将应用程序消息发送给订阅了相同共享订阅的另一个客户端。一旦失去与第一个客户端的连接，它就可以尝试将消息发送给另一个客户端。

* 如果客户端使用包含原始代码0x80或更高的PUBACK或PUBREC来响应来自服务器的PUBLISH数据包，则服务器必须丢弃该应用程序消息，而不是尝试将其发送给任何其他订阅者。

* 允许客户端对已经订阅该共享订阅的会话的共享订阅提交第二个SUBSCRIBE请求。例如，它可能会这样做以更改其订阅的请求QoS，或者因为不确定先前的订阅是否在上一个连接关闭之前完成。这不会增加会话与共享订阅关联的次数，因此会话将在其第一个UNSUBSCRIBE上保留共享订阅。

* 每个共享订阅都独立于任何其他订阅。可以有两个具有重叠过滤器的共享订阅。在这种情况下，与两个共享订阅匹配的消息将由它们两者单独处理；如果客户端具有共享订阅和非共享订阅并且消息与它们都匹配，则客户端将凭借其具有非共享订阅来接收消息的副本。消息的第二个副本将被传递给共享订阅的订阅者之一，这可能导致第二个副本被发送到此客户端。








